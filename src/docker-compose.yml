services:
  collector-server:
    build: ./collector-server
    container_name: collector-server
    ports:
      - "3000:3000"
    env_file:
      - .env
    environment:
      - MONGO_URI=mongodb://mongo1:27017,mongo2:27017,mongo3:27017/distributed-honeypot?replicaSet=rs0
      - PORT=3000
      - JWT_SECRET=supersecretkey_change_this_in_production
      - NODE_ENV=development
    depends_on:
      mongo-init:
        condition: service_completed_successfully
      mongo1:
        condition: service_healthy
      mongo2:
        condition: service_healthy
      mongo3:
        condition: service_healthy
    networks:
      - app-network
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    user: root
    privileged: true

  dashboard-client:
    build:
      context: ./dashboard-client
      dockerfile: Dockerfile
    container_name: dashboard-client
    ports:
      - "8080:80"
    depends_on:
      - collector-server
    networks:
      - app-network
    restart: unless-stopped

  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: mosquitto
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto/config/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - app-network
    healthcheck:
      test: [ "CMD", "mosquitto_sub", "-h", "127.0.0.1", "-t", "healthcheck", "-C", "1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  mongo1:
    image: mongo:6
    container_name: mongo1
    ports: [ "27017:27017" ]
    command: [ "mongod", "--replSet", "rs0", "--bind_ip_all" ]
    volumes: [ "./mongo-data/mongo1:/data/db" ]
    networks: [ "app-network" ]
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 40s

  mongo2:
    image: mongo:6
    container_name: mongo2
    command: [ "mongod", "--replSet", "rs0", "--bind_ip_all" ]
    volumes: [ "./mongo-data/mongo2:/data/db" ]
    networks: [ "app-network" ]
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 40s

  mongo3:
    image: mongo:6
    container_name: mongo3
    command: [ "mongod", "--replSet", "rs0", "--bind_ip_all" ]
    volumes: [ "./mongo-data/mongo3:/data/db" ]
    networks: [ "app-network" ]
    healthcheck:
      test: [ "CMD", "mongosh", "--eval", "db.adminCommand('ping')" ]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 40s

  mongo-init:
    image: mongo:6
    depends_on:
      mongo1:
        condition: service_healthy
      mongo2:
        condition: service_healthy
      mongo3:
        condition: service_healthy
    networks: [ "app-network" ]
    restart: "no"
    command:
      - /bin/bash
      - -c
      - |
        echo "=== Initializing MongoDB Replica Set ==="

        # Wait for all nodes
        echo "Waiting for MongoDB nodes to be ready..."
        for i in {1..30}; do
          if mongosh --host mongo1:27017 --eval "db.adminCommand('ping')" >/dev/null 2>&1 &&
             mongosh --host mongo2:27017 --eval "db.adminCommand('ping')" >/dev/null 2>&1 &&
             mongosh --host mongo3:27017 --eval "db.adminCommand('ping')" >/dev/null 2>&1; then
            echo "✓ All MongoDB nodes are ready"
            break
          fi
          echo "Waiting... ($$i/30)"
          sleep 2
        done

        # Initialize replica set
        echo "Initializing replica set..."
        mongosh --host mongo1:27017 --quiet --eval "
          try {
            let status = rs.status();
            print('✓ Replica set already initialized');
          } catch (e) {
            if (e.codeName === 'NotYetInitialized') {
              print('Initializing new replica set...');
              let result = rs.initiate({
                _id: 'rs0',
                members: [
                  { _id: 0, host: 'mongo1:27017', priority: 2 },
                  { _id: 1, host: 'mongo2:27017', priority: 1 },
                  { _id: 2, host: 'mongo3:27017', priority: 1 }
                ]
              });
              
              if (result.ok) {
                print('✓ Replica set initialized successfully');
                
                // Wait for primary election
                for (let i = 0; i < 15; i++) {
                  try {
                    let status = rs.status();
                    let primary = status.members.find(m => m.stateStr === 'PRIMARY');
                    if (primary) {
                      print('✓ Primary elected: ' + primary.name);
                      break;
                    }
                  } catch (e) {}
                  print('Waiting for primary election... (' + (15-i) + 's)');
                  sleep(2000);
                }
              } else {
                print('Failed to initialize replica set');
                printjson(result);
              }
            } else {
              print('Error: ' + e.message);
            }
          }
        "
        echo "=== Replica Set Initialization Complete ==="

  honeypot-node1:
    build:
      context: .
      dockerfile: ./honeypot-node1/Dockerfile
    container_name: honeypot-node1
    ports:
      - "3001:3001"
    env_file:
      - .env
    environment:
      - COLLECTOR_SERVER_URL=http://collector-server:3000
      - MAX_RETRIES=3
      - RETRY_DELAY=2000
    depends_on:
      - collector-server
    networks:
      - app-network
    restart: unless-stopped

  honeypot-node2:
    build:
      context: .
      dockerfile: ./honeypot-node2/Dockerfile
    container_name: honeypot-node2
    ports:
      - "2222:2222"
    env_file:
      - .env
    environment:
      - COLLECTOR_SERVER_URL=http://collector-server:3000
      - SSH_PORT=2222
    depends_on:
      - collector-server
    networks:
      - app-network
    restart: unless-stopped

  honeypot-node3:
    build:
      context: .
      dockerfile: ./honeypot-node3/Dockerfile
    container_name: honeypot-node3
    ports:
      - "3003:3003"
    env_file:
      - .env
    environment:
      - COLLECTOR_SERVER_URL=http://collector-server:3000
    depends_on:
      - collector-server
    networks:
      - app-network
    restart: unless-stopped

networks:
  app-network:
    driver: bridge
